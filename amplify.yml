version: 1
frontend:
  phases:
    preBuild:
      commands:
        - >
          wget -q https://github.com/gohugoio/hugo/releases/download/v${VERSION_HUGO}/hugo_${VERSION_HUGO}_Linux-64bit.tar.gz && \
               tar -zxf hugo_${VERSION_HUGO}_Linux-64bit.tar.gz hugo && \
               mv hugo /usr/bin/hugo && \
               rm -rf hugo_${VERSION_HUGO}_Linux-64bit.tar.gz
    build:
      commands:
        - npm ci
        - "git clone https://oauth2:$ACCESS_TOKEN@gitlab.com/noritakaIzumi/my-portfolio-posts.git"
        - "rm -rf my-portfolio-posts/.git || exit 1"
        - "mv my-portfolio-posts content || exit 1"
        # https://github.com/gohugoio/hugo/issues/8025
        - "hugo --verbose --minify --cleanDestinationDir --gc --baseURL https://$AWS_BRANCH.$AWS_APP_ID.amplifyapp.com/ --buildDrafts"
        # check there is no empty images
        - test $(find public/images/ -type f -exec stat -c '%s' {} \; | grep '^0$' | wc -l) = 0 || exit 1
  artifacts:
    baseDirectory: public
    files:
      - '**/*'
